name: MAGDA CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.13"

permissions:
  contents: write
  packages: write

jobs:
  test-and-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/uv
          .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Install dependencies
      run: |
        cd python
        uv sync --frozen

    - name: Run tests with coverage
      run: |
        cd python
        uv run pytest --cov=magda --cov-report=xml --cov-report=term-missing

    - name: Run linting
      run: |
        cd python
        uv run ruff check .
        uv run ruff format --check .

    - name: Run type checking
      run: |
        cd python
        uv run mypy magda/

    - name: Run security checks
      run: |
        cd python
        uv run bandit -r magda/ -f json -o bandit-report.json || true
        uv run safety check --json --output safety-report.json || true

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  build-and-release:
    runs-on: ubuntu-latest
    needs: [test-and-quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        cd python
        uv sync --frozen

    - name: Build package
      run: |
        cd python
        uv run python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: python/dist/

    - name: Create Release
      id: create_release
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: `v${context.runNumber}`,
            name: `Release v${context.runNumber}`,
            body: `Automated release for run ${context.runNumber}`,
            draft: false,
            prerelease: false
          });
          core.setOutput('upload_url', release.data.upload_url);
          core.setOutput('release_id', release.data.id);

    - name: Upload Release Assets
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const assetPath = './dist/magda-${{ github.run_number }}.tar.gz';
          const assetName = 'magda-${{ github.run_number }}.tar.gz';

          if (fs.existsSync(assetPath)) {
            const asset = fs.readFileSync(assetPath);
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ steps.create_release.outputs.release_id }},
              name: assetName,
              data: asset,
              headers: {
                'content-type': 'application/gzip'
              }
            });
          } else {
            core.warning(`Asset file ${assetPath} not found`);
          }
